<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Multimodal Perception System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js and COCO-SSD model for object detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
        /* Custom styles for the Ultimate Edition */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a1a;
            color: #E5E7EB;
            background-image: radial-gradient(circle at top left, rgba(58, 1, 90, 0.2), transparent 40%),
                              radial-gradient(circle at bottom right, rgba(0, 50, 150, 0.2), transparent 40%);
            background-attachment: fixed;
            /* FIX: Removed overflow: hidden; to re-enable scrolling */
        }

        .main-title {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7), 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.4);
            background: rgba(0, 0, 0, 0.2);
        }
        #video {
            display: block;
            width: 100%;
            height: auto;
            transform: scaleX(-1);
            transition: filter 0.5s ease;
        }
        /* Vision Mode Filters */
        .vision-normal {}
        .vision-night { filter: grayscale(1) contrast(2) brightness(1.5) hue-rotate(90deg); }
        .vision-thermal { filter: contrast(1.8) brightness(1.2) hue-rotate(-180deg) saturate(3); }

        .canvas-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        #heatmap-canvas { opacity: 0.6; }

        .log-panel {
            background: rgba(20, 20, 40, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 0.75rem;
        }
        .log-header {
            background-color: rgba(0, 255, 255, 0.1);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
        }
        .log-box {
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
        }
        
        #console-input {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-white main-title">ULTIMATE PERCEPTION SYSTEM</h1>
        </header>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
            <div id="status-indicators" class="flex justify-center items-center space-x-6 p-3 bg-black bg-opacity-30 rounded-lg">
                <!-- Status indicators will be dynamically populated -->
            </div>
            <div class="flex items-center space-x-2 bg-black bg-opacity-30 p-2 rounded-lg">
                <label for="lang-select" class="text-sm font-medium text-cyan-300">Language:</label>
                <select id="lang-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg">
                    <option value="en-US">English</option>
                    <option value="hi-IN">Hindi</option>
                    <option value="es-ES">Spanish</option>
                    <option value="fr-FR">French</option>
                </select>
            </div>
        </div>

        <div class="video-container mx-auto mb-6">
            <video id="video" class="vision-normal" autoplay muted playsinline></video>
            <canvas id="heatmap-canvas" class="canvas-layer"></canvas>
            <canvas id="detection-canvas" class="canvas-layer"></canvas>
        </div>

        <div id="controls" class="text-center mb-6 flex flex-wrap justify-center gap-2 sm:gap-4">
            <!-- Buttons will be dynamically populated -->
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="log-panel">
                <div id="vision-log-header" class="log-header p-2 text-center font-bold text-cyan-300">üëÅÔ∏è VISION LOG</div>
                <div id="vision-log" class="log-box p-2 rounded-b-lg"></div>
            </div>
            <div class="log-panel">
                <div id="audio-log-header" class="log-header p-2 text-center font-bold text-cyan-300">üéôÔ∏è AUDIO LOG</div>
                <div id="audio-log" class="log-box p-2 rounded-b-lg"></div>
            </div>
        </div>

        <div class="mt-6">
            <div class="relative">
                <input type="text" id="console-input" class="w-full bg-black bg-opacity-50 border-2 border-cyan-500 rounded-lg p-3 text-cyan-300 placeholder-cyan-700 focus:ring-2 focus:ring-cyan-300 focus:outline-none" placeholder="Type command (e.g., 'night vision on') and press Enter">
                <span class="absolute left-3 top-3.5 text-cyan-500 font-bold">></span>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const detectionCanvas = document.getElementById('detection-canvas');
        const heatmapCanvas = document.getElementById('heatmap-canvas');
        const d_ctx = detectionCanvas.getContext('2d');
        const h_ctx = heatmapCanvas.getContext('2d');
        const langSelect = document.getElementById('lang-select');
        const visionLog = document.getElementById('vision-log');
        const audioLog = document.getElementById('audio-log');
        const consoleInput = document.getElementById('console-input');
        const statusIndicators = document.getElementById('status-indicators');
        const controlsContainer = document.getElementById('controls');

        // App State
        let model, speechRecognition, synth;
        let isAudioSupported = false;
        let systemActive = false;
        let lastSpokenObject = '';
        let lastSpokenTime = 0;

        // --- CORE SYSTEMS ---

        const System = {
            async initialize() {
                this.setupUI();
                synth = window.speechSynthesis;
                this.speak("System initializing. Please wait.", true);
                await this.loadVisionModel();
                this.setupAudioSystem();
                this.setupEventListeners();
                this.loadPreferences();
                this.log('SYSTEM', 'Ready. Press "Start System" or use voice/text commands.');
            },

            setupUI() {
                statusIndicators.innerHTML = `
                    <div class="flex items-center space-x-2"><span id="vision-status" class="w-3 h-3 bg-yellow-400 rounded-full"></span><span>Vision</span></div>
                    <div class="flex items-center space-x-2"><span id="audio-status" class="w-3 h-3 bg-yellow-400 rounded-full"></span><span>Audio</span></div>
                `;
                controlsContainer.innerHTML = `
                    <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" disabled>Start System</button>
                    <button id="snapshotButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" disabled>Snapshot</button>
                    <select id="visionModeSelect" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" disabled>
                        <option value="normal">Normal Vision</option>
                        <option value="night">Night Vision</option>
                        <option value="thermal">Thermal Vision</option>
                    </select>
                `;
            },

            async loadVisionModel() {
                try {
                    model = await cocoSsd.load();
                    this.updateStatus('vision', 'green', 'Ready');
                    document.getElementById('startButton').disabled = false;
                } catch (err) {
                    this.updateStatus('vision', 'red', 'Failed');
                    this.log('SYSTEM', 'Error loading vision model.', 'error');
                }
            },

            setupAudioSystem() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    this.updateStatus('audio', 'red', 'Unsupported');
                    isAudioSupported = false;
                    langSelect.disabled = true;
                    return;
                }
                isAudioSupported = true;
                this.updateStatus('audio', 'green', 'Ready');
                speechRecognition = new SpeechRecognition();
                Object.assign(speechRecognition, {
                    continuous: true,
                    interimResults: true,
                    lang: langSelect.value,
                });
                speechRecognition.onresult = this.handleVoiceCommand.bind(this);
                speechRecognition.onend = () => { if (systemActive) speechRecognition.start(); };
            },

            start() {
                if (systemActive) return;
                this.log('SYSTEM', 'Starting perception systems...');
                this.speak("Systems activated.");
                systemActive = true;
                
                navigator.mediaDevices.getUserMedia({ video: true, audio: isAudioSupported })
                    .then(stream => {
                        video.srcObject = stream;
                        video.onloadeddata = () => {
                            this.resizeCanvases();
                            this.mainLoop();
                            if (isAudioSupported) speechRecognition.start();
                            document.getElementById('startButton').textContent = 'Stop System';
                            document.getElementById('snapshotButton').disabled = false;
                            document.getElementById('visionModeSelect').disabled = false;
                        };
                    }).catch(err => {
                        this.log('SYSTEM', 'Media device access denied.', 'error');
                        this.speak("Error. Camera access denied.");
                        systemActive = false;
                    });
            },

            stop() {
                if (!systemActive) return;
                this.log('SYSTEM', 'Stopping perception systems.');
                this.speak("Systems deactivated.");
                systemActive = false;
                
                video.srcObject?.getTracks().forEach(track => track.stop());
                if (isAudioSupported) speechRecognition.stop();
                
                d_ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                h_ctx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
                
                document.getElementById('startButton').textContent = 'Start System';
                document.getElementById('snapshotButton').disabled = true;
                document.getElementById('visionModeSelect').disabled = true;
            },

            mainLoop() {
                if (!systemActive) return;
                this.detectObjects();
                this.updateHeatmap();
                requestAnimationFrame(this.mainLoop.bind(this));
            },

            detectObjects() {
                if (!model || video.paused || video.ended) return;
                model.detect(video).then(predictions => {
                    const filtered = predictions.filter(p => p.score > 0.6);
                    d_ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    this.drawDetections(filtered);
                    this.drawHeatmapObjects(filtered);
                    this.logVision(filtered);
                });
            },

            handleVoiceCommand(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                }
                if (finalTranscript) {
                    this.log('AUDIO', `"${finalTranscript.trim()}"`);
                    this.processCommand(finalTranscript.toLowerCase().trim());
                }
            },

            processCommand(command) {
                if (command.includes("start")) this.start();
                else if (command.includes("stop")) this.stop();
                else if (command.includes("night vision")) this.setVisionMode('night');
                else if (command.includes("thermal vision")) this.setVisionMode('thermal');
                else if (command.includes("normal vision")) this.setVisionMode('normal');
                else if (command.includes("take photo") || command.includes("snapshot")) this.takeSnapshot();
                else if (command.includes("clear logs")) this.clearLogs();
            },

            setVisionMode(mode) {
                video.className = `vision-${mode}`;
                document.getElementById('visionModeSelect').value = mode;
                this.log('SYSTEM', `Vision mode set to ${mode}.`);
                this.speak(`${mode} vision enabled.`);
                this.savePreferences();
            },

            takeSnapshot() {
                d_ctx.drawImage(video, 0, 0, detectionCanvas.width, detectionCanvas.height);
                const link = document.createElement('a');
                link.download = `snapshot-${Date.now()}.png`;
                link.href = detectionCanvas.toDataURL();
                link.click();
                this.log('SYSTEM', 'Snapshot saved.');
                this.speak("Snapshot taken.");
            },
            
            clearLogs() {
                visionLog.innerHTML = '';
                audioLog.innerHTML = '';
                this.log('SYSTEM', 'Logs cleared.');
            },

            speak(text, force = false) {
                if (!synth) return;
                if (synth.speaking && !force) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langSelect.value;
                synth.speak(utterance);
            },
            
            setupEventListeners() {
                document.getElementById('startButton').onclick = () => systemActive ? this.stop() : this.start();
                document.getElementById('snapshotButton').onclick = () => this.takeSnapshot();
                document.getElementById('visionModeSelect').onchange = (e) => this.setVisionMode(e.target.value);
                langSelect.onchange = () => {
                    if (isAudioSupported) {
                        speechRecognition.lang = langSelect.value;
                        if(systemActive) {
                            speechRecognition.stop(); // onend will restart it
                        }
                    }
                    this.savePreferences();
                };
                consoleInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        this.log('CONSOLE', `> ${e.target.value}`);
                        this.processCommand(e.target.value.toLowerCase());
                        e.target.value = '';
                    }
                };
                window.onresize = () => this.resizeCanvases();
            },
            
            savePreferences() {
                localStorage.setItem('perceptionSystemPrefs', JSON.stringify({
                    language: langSelect.value,
                    visionMode: document.getElementById('visionModeSelect').value
                }));
            },

            loadPreferences() {
                const prefs = JSON.parse(localStorage.getItem('perceptionSystemPrefs'));
                if (prefs) {
                    langSelect.value = prefs.language || 'en-US';
                    this.setVisionMode(prefs.visionMode || 'normal');
                }
            },

            // --- DRAWING & LOGGING ---
            
            resizeCanvases() {
                [detectionCanvas, heatmapCanvas].forEach(canvas => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
            },

            drawDetections(predictions) {
                predictions.forEach(p => {
                    d_ctx.strokeStyle = 'rgba(0, 255, 255, 0.8)';
                    d_ctx.lineWidth = 2;
                    d_ctx.strokeRect(...p.bbox);
                    d_ctx.font = '16px Orbitron';
                    const label = `${p.class.toUpperCase()} ${Math.round(p.score*100)}%`;
                    d_ctx.fillStyle = 'rgba(0, 255, 255, 0.8)';
                    d_ctx.fillText(label, p.bbox[0] + 5, p.bbox[1] + 15);
                });
            },
            
            drawHeatmapObjects(predictions) {
                predictions.forEach(p => {
                    h_ctx.fillStyle = 'rgba(255, 100, 0, 0.1)';
                    h_ctx.fillRect(...p.bbox);
                });
            },

            updateHeatmap() {
                h_ctx.fillStyle = 'rgba(10, 10, 26, 0.05)'; // Fade effect
                h_ctx.fillRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            },

            log(type, message, level = 'info') {
                const logMap = { 'VISION': visionLog, 'AUDIO': audioLog, 'SYSTEM': visionLog, 'CONSOLE': audioLog };
                const colorMap = { 'VISION': 'text-cyan-400', 'AUDIO': 'text-purple-400', 'SYSTEM': 'text-yellow-400', 'CONSOLE': 'text-green-400' };
                const targetLog = logMap[type] || visionLog;

                const newEntry = document.createElement('div');
                newEntry.innerHTML = `<span>[${type}]</span> <span class="${colorMap[type]}">${message}</span>`;
                targetLog.prepend(newEntry);
                if (targetLog.children.length > 50) targetLog.removeChild(targetLog.lastChild);
            },
            
            logVision(predictions) {
                if (predictions.length > 0) {
                    const objectNames = predictions.map(p => p.class).join(', ');
                    this.log('VISION', `${objectNames} (${predictions.length})`);

                    const now = Date.now();
                    if (now - lastSpokenTime > 5000) { // Speak only every 5s
                        const newObject = predictions[0].class;
                        if (newObject !== lastSpokenObject) {
                            this.speak(`I see a ${newObject}`);
                            lastSpokenObject = newObject;
                            lastSpokenTime = now;
                        }
                    }
                }
            },

            updateStatus(system, color, text) {
                const dot = document.getElementById(`${system}-status`);
                if (dot) {
                    dot.className = `w-3 h-3 ${'bg-' + color + '-400'} rounded-full`;
                }
            }
        };

        // Initialize the system on load
        window.onload = () => System.initialize();
    </script>
</body>
</html>
