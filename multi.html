<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Multimodal Perception System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js and COCO-SSD model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        window.firebase = { initializeApp, getFirestore, collection, addDoc, serverTimestamp, getAuth, signInAnonymously };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;500&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a1a;
            color: #E5E7EB;
            background-image: radial-gradient(circle at top left, rgba(58, 1, 90, 0.2), transparent 40%),
                              radial-gradient(circle at bottom right, rgba(0, 50, 150, 0.2), transparent 40%);
            background-attachment: fixed;
        }
        .main-title { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px rgba(0, 255, 255, 0.7); }
        .video-container { position: relative; width: 100%; max-width: 640px; border-radius: 0.75rem; overflow: hidden; border: 2px solid rgba(0, 255, 255, 0.4); background: rgba(0, 0, 0, 0.2); }
        #video { display: block; width: 100%; height: auto; transform: scaleX(-1); transition: filter 0.5s ease; }
        .vision-normal {}
        .vision-night { filter: grayscale(1) contrast(2) brightness(1.5) hue-rotate(90deg); }
        .vision-thermal { filter: contrast(1.8) brightness(1.2) hue-rotate(-180deg) saturate(3); }
        .canvas-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        #heatmap-canvas { opacity: 0.6; }
        .panel { background: rgba(20, 20, 40, 0.5); backdrop-filter: blur(10px); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 0.75rem; }
        .panel-header { background-color: rgba(0, 255, 255, 0.1); border-bottom: 1px solid rgba(0, 255, 255, 0.2); font-family: 'Orbitron', sans-serif; }
        .log-box { height: 200px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; }
        #console-input { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-white main-title">ENTERPRISE PERCEPTION SYSTEM</h1>
        </header>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
            <div id="status-indicators" class="flex justify-center items-center space-x-4 p-3 bg-black bg-opacity-30 rounded-lg"></div>
            <div class="flex items-center space-x-4 bg-black bg-opacity-30 p-2 rounded-lg">
                <div>
                    <label for="model-select" class="text-sm font-medium text-cyan-300">Model:</label>
                    <select id="model-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg">
                        <option value="general">General</option>
                        <option value="animal">Animal Recognition</option>
                    </select>
                </div>
                <div>
                    <label for="lang-select" class="text-sm font-medium text-cyan-300">Language:</label>
                    <select id="lang-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg">
                        <option value="en-US">English</option>
                        <option value="hi-IN">Hindi</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="video-container mx-auto mb-6">
            <video id="video" class="vision-normal" autoplay muted playsinline></video>
            <canvas id="heatmap-canvas" class="canvas-layer"></canvas>
            <canvas id="detection-canvas" class="canvas-layer"></canvas>
        </div>

        <div id="controls" class="text-center mb-6 flex flex-wrap justify-center gap-2 sm:gap-4"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="panel lg:col-span-1">
                <div class="panel-header p-2 text-center font-bold text-cyan-300">üëÅÔ∏è VISION LOG</div>
                <div id="vision-log" class="log-box p-2"></div>
            </div>
            <div class="panel lg:col-span-1">
                <div class="panel-header p-2 text-center font-bold text-cyan-300">üéôÔ∏è AUDIO LOG</div>
                <div id="audio-log" class="log-box p-2"></div>
            </div>
            <div class="panel lg:col-span-1">
                <div class="panel-header p-2 text-center font-bold text-cyan-300">üìä CONFIDENCE MONITOR</div>
                <div class="p-2"><canvas id="confidence-chart"></canvas></div>
            </div>
        </div>

        <div class="mt-6">
            <div class="relative">
                <input type="text" id="console-input" class="w-full bg-black bg-opacity-50 border-2 border-cyan-500 rounded-lg p-3 text-cyan-300" placeholder="Type command... (e.g., 'night vision on')">
                <span class="absolute left-3 top-3.5 text-cyan-500 font-bold">></span>
            </div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace this with your own Firebase project configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyDiWVKR-SmLvjIWdE4I4oqkfOU8xqwXYF4",
            authDomain: "perception-system-db.firebaseapp.com",
            projectId: "perception-system-db",
            storageBucket: "perception-system-db.firebasestorage.app",
            messagingSenderId: "1098859848294",
            appId: "1:1098859848294:web:8d016d887a61f88f4f03a7"
        };

        // DOM Elements
        const video = document.getElementById('video');
        const detectionCanvas = document.getElementById('detection-canvas');
        const heatmapCanvas = document.getElementById('heatmap-canvas');
        const d_ctx = detectionCanvas.getContext('2d');
        const h_ctx = heatmapCanvas.getContext('2d');
        const langSelect = document.getElementById('lang-select');
        const modelSelect = document.getElementById('model-select');
        const visionLog = document.getElementById('vision-log');
        const audioLog = document.getElementById('audio-log');
        const consoleInput = document.getElementById('console-input');
        const statusIndicators = document.getElementById('status-indicators');
        const controlsContainer = document.getElementById('controls');
        const chartCanvas = document.getElementById('confidence-chart');

        // App State
        let model, speechRecognition, synth, confidenceChart;
        let db, auth;
        let isAudioSupported = false, systemActive = false, firebaseReady = false;
        let lastSpokenObject = '', lastSpokenTime = 0;
        const ANIMAL_CLASSES = ['bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe'];

        // --- CORE SYSTEM OBJECT ---
        const System = {
            async initialize() {
                this.setupUI();
                synth = window.speechSynthesis;
                this.speak("System initializing.", true);
                await this.setupFirebase();
                await this.loadVisionModel();
                this.setupAudioSystem();
                this.setupChart();
                this.setupEventListeners();
                this.log('SYSTEM', 'Ready. Use Start button or commands.');
            },

            setupUI() {
                statusIndicators.innerHTML = `
                    <div class="flex items-center space-x-2"><span id="vision-status" class="w-3 h-3 bg-yellow-400 rounded-full"></span><span>Vision</span></div>
                    <div class="flex items-center space-x-2"><span id="audio-status" class="w-3 h-3 bg-yellow-400 rounded-full"></span><span>Audio</span></div>
                    <div class="flex items-center space-x-2"><span id="db-status" class="w-3 h-3 bg-yellow-400 rounded-full"></span><span>Database</span></div>
                `;
                controlsContainer.innerHTML = `
                    <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" disabled>Start System</button>
                    <button id="snapshotButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" disabled>Snapshot</button>
                    <select id="visionModeSelect" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" disabled>
                        <option value="normal">Normal</option> <option value="night">Night</option> <option value="thermal">Thermal</option>
                    </select>
                `;
            },
            
            async setupFirebase() {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    this.updateStatus('db', 'red');
                    this.log('SYSTEM', 'Firebase config missing. DB logging disabled.', 'error');
                    firebaseReady = false;
                    return;
                }
                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    db = window.firebase.getFirestore(app);
                    auth = window.firebase.getAuth(app);
                    await window.firebase.signInAnonymously(auth);
                    this.updateStatus('db', 'green');
                    this.log('SYSTEM', 'Firebase connected. Logging enabled.');
                    firebaseReady = true;
                } catch (err) {
                    this.updateStatus('db', 'red');
                    this.log('SYSTEM', `Firebase connection error: ${err.message}`, 'error');
                    firebaseReady = false;
                }
            },

            async loadVisionModel() {
                try {
                    model = await cocoSsd.load();
                    this.updateStatus('vision', 'green');
                    document.getElementById('startButton').disabled = false;
                } catch (err) {
                    this.updateStatus('vision', 'red');
                    this.log('SYSTEM', 'Error loading vision model.', 'error');
                }
            },

            setupAudioSystem() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    this.updateStatus('audio', 'red');
                    isAudioSupported = false;
                    return;
                }
                isAudioSupported = true;
                this.updateStatus('audio', 'green');
                speechRecognition = new SpeechRecognition();
                Object.assign(speechRecognition, { continuous: true, interimResults: true, lang: langSelect.value });
                speechRecognition.onresult = this.handleVoiceCommand.bind(this);
                speechRecognition.onend = () => { if (systemActive) speechRecognition.start(); };
            },

            setupChart() {
                const chartCtx = chartCanvas.getContext('2d');
                confidenceChart = new Chart(chartCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Top Object Confidence', data: [], borderColor: 'rgba(0, 255, 255, 0.8)', backgroundColor: 'rgba(0, 255, 255, 0.2)', fill: true, tension: 0.4 }] },
                    options: {
                        scales: { y: { beginAtZero: true, max: 1, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                        plugins: { legend: { labels: { color: '#9ca3af' } } }
                    }
                });
            },

            // **FIX**: Restored the full start() function logic
            start() {
                if (systemActive) return;
                this.log('SYSTEM', 'Starting perception systems...');
                this.speak("Systems activated.");
                systemActive = true;
                
                navigator.mediaDevices.getUserMedia({ video: true, audio: isAudioSupported })
                    .then(stream => {
                        video.srcObject = stream;
                        video.onloadeddata = () => {
                            this.resizeCanvases();
                            this.mainLoop();
                            if (isAudioSupported) speechRecognition.start();
                            document.getElementById('startButton').textContent = 'Stop System';
                            document.getElementById('snapshotButton').disabled = false;
                            document.getElementById('visionModeSelect').disabled = false;
                        };
                    }).catch(err => {
                        this.log('SYSTEM', 'Media device access denied.', 'error');
                        this.speak("Error. Camera access denied.");
                        systemActive = false;
                    });
            },

            // **FIX**: Restored the full stop() function logic
            stop() {
                if (!systemActive) return;
                this.log('SYSTEM', 'Stopping perception systems.');
                this.speak("Systems deactivated.");
                systemActive = false;
                
                video.srcObject?.getTracks().forEach(track => track.stop());
                if (isAudioSupported) speechRecognition.stop();
                
                d_ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                h_ctx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
                
                document.getElementById('startButton').textContent = 'Start System';
                document.getElementById('snapshotButton').disabled = true;
                document.getElementById('visionModeSelect').disabled = true;
            },

            mainLoop() {
                if (!systemActive) return;
                this.detectObjects();
                this.updateHeatmap();
                requestAnimationFrame(this.mainLoop.bind(this));
            },

            detectObjects() {
                if (!model || video.paused) return;
                model.detect(video).then(predictions => {
                    let filtered = predictions;
                    if (modelSelect.value === 'animal') {
                        filtered = predictions.filter(p => ANIMAL_CLASSES.includes(p.class));
                    }
                    const finalPredictions = filtered.filter(p => p.score > 0.6);
                    d_ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                    this.drawDetections(finalPredictions);
                    this.drawHeatmapObjects(finalPredictions);
                    this.logVision(finalPredictions);
                    this.updateChart(finalPredictions);
                });
            },

            handleVoiceCommand(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                }
                if (finalTranscript) {
                    this.log('AUDIO', `"${finalTranscript.trim()}"`);
                    this.processCommand(finalTranscript.toLowerCase().trim());
                }
            },

            processCommand(command) {
                if (command.includes("start")) this.start();
                else if (command.includes("stop")) this.stop();
                else if (command.includes("night vision")) this.setVisionMode('night');
                else if (command.includes("thermal vision")) this.setVisionMode('thermal');
                else if (command.includes("normal vision")) this.setVisionMode('normal');
                else if (command.includes("take photo") || command.includes("snapshot")) this.takeSnapshot();
            },

            setVisionMode(mode) {
                video.className = `vision-${mode}`;
                document.getElementById('visionModeSelect').value = mode;
                this.log('SYSTEM', `Vision mode set to ${mode}.`);
                this.speak(`${mode} vision enabled.`);
            },

            takeSnapshot() {
                d_ctx.drawImage(video, 0, 0, detectionCanvas.width, detectionCanvas.height);
                const link = document.createElement('a');
                link.download = `snapshot-${Date.now()}.png`;
                link.href = detectionCanvas.toDataURL();
                link.click();
                this.log('SYSTEM', 'Snapshot saved.');
                this.speak("Snapshot taken.");
            },

            speak(text, force = false) {
                if (!synth) return;
                if (synth.speaking && !force) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langSelect.value;
                synth.speak(utterance);
            },

            log(type, message, level = 'info') {
                const logMap = { 'VISION': visionLog, 'AUDIO': audioLog, 'SYSTEM': visionLog, 'CONSOLE': audioLog };
                const colorMap = { 'VISION': 'text-cyan-400', 'AUDIO': 'text-purple-400', 'SYSTEM': 'text-yellow-400', 'CONSOLE': 'text-green-400' };
                const targetLog = logMap[type] || visionLog;
                const newEntry = document.createElement('div');
                newEntry.innerHTML = `<span>[${type}]</span> <span class="${colorMap[type]}">${message}</span>`;
                targetLog.prepend(newEntry);
                if (targetLog.children.length > 50) targetLog.removeChild(targetLog.lastChild);

                if (firebaseReady && auth.currentUser) {
                    const { addDoc, collection, serverTimestamp } = window.firebase;
                    try {
                        addDoc(collection(db, "events"), {
                            type: type,
                            message: message,
                            level: level,
                            timestamp: serverTimestamp(),
                            userId: auth.currentUser.uid
                        });
                    } catch (err) {
                        console.error("Error writing to Firestore:", err);
                    }
                }
            },
            
            logVision(predictions) {
                if (predictions.length > 0) {
                    const objectNames = predictions.map(p => p.class).join(', ');
                    this.log('VISION', `${objectNames} (${predictions.length})`);
                    const now = Date.now();
                    if (now - lastSpokenTime > 5000) {
                        const newObject = predictions[0].class;
                        if (newObject !== lastSpokenObject) {
                            this.speak(`I see a ${newObject}`);
                            lastSpokenObject = newObject;
                            lastSpokenTime = now;
                        }
                    }
                }
            },
            
            updateChart(predictions) {
                if (predictions.length > 0) {
                    const topPrediction = predictions[0];
                    const confidence = topPrediction.score;
                    const label = new Date().toLocaleTimeString().split(" ")[0];
                    confidenceChart.data.labels.push(label);
                    confidenceChart.data.datasets[0].data.push(confidence);
                    if (confidenceChart.data.labels.length > 20) {
                        confidenceChart.data.labels.shift();
                        confidenceChart.data.datasets[0].data.shift();
                    }
                    confidenceChart.update('none');
                }
            },

            updateStatus(system, color) {
                const dot = document.getElementById(`${system}-status`);
                if (dot) dot.className = `w-3 h-3 bg-${color}-400 rounded-full`;
            },
            
            resizeCanvases() {
                [detectionCanvas, heatmapCanvas].forEach(canvas => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
            },
            drawDetections(predictions) {
                predictions.forEach(p => {
                    d_ctx.strokeStyle = 'rgba(0, 255, 255, 0.8)';
                    d_ctx.lineWidth = 2;
                    d_ctx.strokeRect(...p.bbox);
                    d_ctx.font = '16px Orbitron';
                    const label = `${p.class.toUpperCase()} ${Math.round(p.score*100)}%`;
                    d_ctx.fillStyle = 'rgba(0, 255, 255, 0.8)';
                    d_ctx.fillText(label, p.bbox[0] + 5, p.bbox[1] + 15);
                });
            },
            drawHeatmapObjects(predictions) {
                predictions.forEach(p => {
                    h_ctx.fillStyle = 'rgba(255, 100, 0, 0.1)';
                    h_ctx.fillRect(...p.bbox);
                });
            },
            updateHeatmap() {
                h_ctx.fillStyle = 'rgba(10, 10, 26, 0.05)';
                h_ctx.fillRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            },
            setupEventListeners() {
                document.getElementById('startButton').onclick = () => systemActive ? this.stop() : this.start();
                document.getElementById('snapshotButton').onclick = () => this.takeSnapshot();
                document.getElementById('visionModeSelect').onchange = (e) => this.setVisionMode(e.target.value);
                langSelect.onchange = () => {
                    if (isAudioSupported) {
                        speechRecognition.lang = langSelect.value;
                        if(systemActive) speechRecognition.stop();
                    }
                };
                consoleInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        this.log('CONSOLE', `> ${e.target.value}`);
                        this.processCommand(e.target.value.toLowerCase());
                        e.target.value = '';
                    }
                };
                window.onresize = () => this.resizeCanvases();
            },
        };

        System.initialize();
    </script>
</body>
</html>

